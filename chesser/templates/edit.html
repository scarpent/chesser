<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block title %}Edit{% endblock %}
{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/variation.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/analysis.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/save.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/back.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/forward.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/up.svg' %}" as="image" />
<link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
{% endblock %}

<!-- prettier-ignore -->
{% block content %}
<body
  x-data="editApp()"
  x-init="initEditor(); document.title = 'Edit #' + variationData.variation_id"
  @keydown.window="handleKeyNavigation($event)"
  x-cloak
>
  <div class="button-container" style="margin-top: 15px">
    <button
      title="Home"
      @click="window.location.href = '/'"
      class="image-button home-button button-round"
    >
      <img src="{% static 'images/chesser-logo-192x192.png' %}" alt="Chesser Logo" />
    </button>
    <button
      title="Review"
      @click="window.location.href='/review/'"
      class="icon-review icon-button"
    ></button>
    <button
      title="Import"
      @click="window.location.href='/import/'"
      class="icon-import icon-button"
    ></button>
    <button
      title="View"
      @click="window.location.href='/variation/' + variationData.variation_id + '/'"
      class="icon-variation icon-button"
    ></button>
    <button
      title="Lichess analysis board"
      @click="window.open(variationData.analysis_url, target='_blank')"
      class="icon-analysis icon-button"
    ></button>
    <button
      title="Save"
      @click="saveVariation()"
      class="icon-save icon-button"
    ></button>
  </div>

  <div id="edit-variation-info" class="form-standard">
    <div>
      <a
        :href="'/course/' + variationData.course_id + '/chapter/' + variationData.chapter_id + '/?id=' + variationData.variation_id"
        x-text="variationData.chapter"
      ></a>
      â€¢
      <a
        :href="'/admin/chesser/variation/' + variationData.variation_id + '/change/'"
        target="_blank"
        x-text="'#' + variationData.variation_id"
      ></a>
      <span x-show="variationData.is_intro">ðŸ“Œ</span>
    </div>

    <div>
      <label for="variation-title">Variation Title:</label>
      <input
        type="text"
        id="variation-title"
        x-model="variationData.title"
        class="variation-title-input"
      />
    </div>

    <div class="edit-sundry">
      <div class="form-start-and-end">
        <label for="start-move">Start Move:</label>
        <input type="text" id="start-move" x-model="variationData.start_move" />
      </div>

      <div>
        <a :href="'/export/' + variationData.variation_id + '/'" target="_blank"
          >export</a
        >
        â€¢
        <a :href="'/import/?clone=' + variationData.variation_id">clone</a> â€¢
        <a :href="'/review/' + variationData.variation_id + '/'">extra&nbsp;study</a>
        <template x-if="variationData.level === 0">
          <span>
            â€¢
            <a :href="'/review/' + variationData.variation_id + '/?learn=1'">learn</a>
          </span>
        </template>
      </div>
    </div>

    <div id="edit-mainline-moves" x-html="renderMainlineMoveLinks()"></div>
  </div>

  <!-- Generate multiple boards dynamically -->
  <div id="boards-container" class="form-standard">
    <template x-for="(move, index) in variationData.moves" :key="index">
      <div class="move-block" :id="'move-block-' + index">
        <div class="edit-board" :id="'edit-board-' + index"></div>
        <div class="edit-move-text-container">
          <h2 class="mainline-move move-verbose-edit" x-text="move.move_verbose"></h2>
          <textarea
            class="edit-move-text"
            x-model="moveState[index].text"
            rows="8"
          ></textarea>
          <div class="move-fen">
            <a
              :href="variationData.analysis_url + (index + 1)"
              target="_blank"
              x-text="move.fen"
            ></a>
          </div>
        </div>
        <div class="edit-move-other-container">
          <select
            :value="move.shared_move_id"
            @change="move.shared_move_id = $event.target.value; updateSharedMoveState(index)"
          >
            <template x-for="item in move.shared_dropdown" :key="item.value">
              <option
                :value="String(item.value)"
                x-text="item.label"
                :selected="item.value === move.shared_move_id"
              ></option>
            </template>
          </select>
          <select class="annotation" x-model="moveState[index].annotation">
            <template x-for="[key, value] in Object.entries(variationData.annotations)">
              <option
                :value="key"
                x-text="value"
                :selected="key === moveState[index].annotation"
              ></option>
            </template>
          </select>
          <input
            type="text"
            class="move-alt"
            x-model="moveState[index].alt"
            placeholder="Alternative move"
            @blur="validateAltMoves(index, 'alt')"
          />
          <input
            type="text"
            class="move-alt-fail"
            x-model="moveState[index].alt_fail"
            placeholder="Alt move fail"
            @blur="validateAltMoves(index, 'alt_fail')"
          />
          <div>
            <button
              title="Save"
              class="icon-save icon-button"
              :class="{
                'save-success': move.saved === 'success',
                'save-error': move.saved === 'error'
              }"
              @click.prevent="saveFromMove(index)"
            ></button>
            <button
              title="Previous Move"
              class="icon-back icon-button"
              @click.prevent="scrollToMoveBlock(index - 1)"
            ></button>
            <button
              title="Next Move"
              class="icon-forward icon-button"
              @click.prevent="scrollToMoveBlock(index + 1)"
            ></button>
            <!-- utterly defeated trying to scroll to top on mobile; will use this for now -->
            <button
              title="Go to Top"
              class="icon-up icon-button"
              @click.prevent="scrollToMoveBlock(0)"
            ></button>
          </div>
          <div id="edit-move-other-links">
            <a :href="'/variation/' + variationData.variation_id + '/?idx=' + index"
              >book view</a
            >
            <template x-if="move.matching_move_count > 0">
              <a
                :href="buildAdminMatchingLink(move)"
                target="_blank"
                title="Show matching SAN/FEN"
                x-text="'=' + move.matching_move_count"
              ></a>
            </template>
            <a
              :href="'/admin/chesser/move/' + move.move_id + '/change/'"
              target="_blank"
              x-text="'#' + move.move_id"
            ></a>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- prettier-ignore -->
  {% include "includes/landscape_overlay.html" %}
  {% include "includes/service_worker_register.html" %}

  <script>
    window.variationData = JSON.parse("{{ variation_data|escapejs }}");
    console.log("variationData:", window.variationData); // Debugging
  </script>

  <!-- dev caching bugbear calls for this prod redundant cache buster -->
  <script type="module">
    import { editApp } from "{% static 'js/edit.js' %}?v={{ BUILD_TIMESTAMP }}";
    window.editApp = editApp;
    document.addEventListener("alpine:init", () => {
      Alpine.data("editApp", editApp);
    });
  </script>

  <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
</body>
{% endblock %}
