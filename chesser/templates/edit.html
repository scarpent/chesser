<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block title %}Edit{% endblock %}
{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/variation.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/analysis.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/save.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/back.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/forward.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/up.svg' %}" as="image" />
<link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
<link
  href="{% static 'chessground/chessground.'|add:CHESS_BOARD_COLOR|add:'.css' %}"
  rel="stylesheet"
/>
<link
  href="{% static 'chessground/chessground.'|add:CHESS_PIECE_SET|add:'.css' %}"
  rel="stylesheet"
/>
<link href="{% static 'chessground/chessground.overrides.css' %}" rel="stylesheet" />
{% endblock %}

<!-- prettier-ignore -->
{% block body_attrs %}
x-data="editApp()"
x-init="initEditor(); setPageTitle('Edit #' + variationData.variation_id);"
@keydown.window="handleKeyNavigation($event)"
x-cloak
{% endblock %}

{% block content %}
<!-- prettier-ignore -->
{% if IS_DEMO %}
<div class="demo-banner" x-cloak>üß™ <b>Demo mode</b> ‚Äî changes are not saved</div>
{% endif %}

<div class="button-container" style="margin-top: 15px">
  <button
    title="Home"
    @click="window.navigateWithSpinner('/')"
    class="image-button home-button button-round"
  >
    <img src="{% static 'images/chesser-logo-192x192.png' %}" alt="Chesser Logo" />
  </button>
  <button
    title="Review Next Due"
    @click="window.navigateWithSpinner('/review/')"
    class="icon-review icon-button"
  ></button>
  <button
    title="Import / Export"
    @click="window.navigateWithSpinner('/import/')"
    class="icon-import icon-button"
  ></button>
  <button
    title="View"
    @click="window.navigateWithSpinner('/variation/' + variationData.variation_id + '/')"
    class="icon-variation icon-button"
  ></button>
  <button
    title="Lichess analysis board"
    @click="window.open(variationData.analysis_url, '_blank', 'noopener')"
    class="icon-analysis icon-button"
  ></button>
  <button title="Save" @click="saveVariation()" class="icon-save icon-button"></button>
</div>

<div id="edit-variation-info" class="form-standard">
  <div>
    <a
      title="Go to chapter and highlight this variation"
      :href="'/chapters/' + variationData.color + '/' + variationData.chapter_id + '/?id=' + variationData.variation_id"
      x-text="variationData.chapter"
    ></a>
    ‚Ä¢
    <a
      title="Edit variation in Django admin (edit chapter, archived state, etc.)"
      :href="'/admin/chesser/variation/' + variationData.variation_id + '/change/'"
      target="_blank"
      rel="noopener"
      x-text="'#' + variationData.variation_id"
    ></a>
    <span x-show="variationData.is_intro">üìå</span>
    <span x-show="variationData.archived">üóÑÔ∏è Archived</span>
  </div>

  <div>
    <label for="variation-title">Variation Title:</label>
    <input
      type="text"
      id="variation-title"
      x-model="variationData.title"
      class="variation-title-input"
    />
  </div>

  <div class="edit-sundry">
    <div class="form-start-and-end">
      <label for="start-move">Start Move:</label>
      <input type="text" id="start-move" x-model="variationData.start_move" />
    </div>

    <div>
      <a
        title="Show variation in chesser json format"
        :href="'/export/' + variationData.variation_id + '/'"
        target="_blank"
        rel="noopener"
        >export</a
      >
      ‚Ä¢
      <a
        title="Clone this variation for editing"
        :href="'/import/?clone=' + variationData.variation_id"
        >clone</a
      >
      ‚Ä¢
      <a
        title="Practice without recording history or advancing level"
        :href="'/review/' + variationData.variation_id + '/'"
        >extra&nbsp;study</a
      >
      <template x-if="variationData.level === 0 && !variationData.archived">
        <span>
          ‚Ä¢
          <a
            title="Start regular review with spaced repetition"
            :href="'/review/' + variationData.variation_id + '/?learn=1'"
            >learn</a
          >
        </span>
      </template>
    </div>
  </div>

  <div id="edit-mainline-moves" x-html="renderMainlineMoveLinks()"></div>
</div>

<!-- Generate multiple boards dynamically -->
<div id="boards-container" class="form-standard" style="margin-bottom: 1000px">
  <template x-for="(move, index) in variationData.moves" :key="index">
    <div class="move-block" :id="'move-block-' + index">
      <div class="edit-board" :id="'edit-board-' + index"></div>
      <div class="edit-move-text-container">
        <h2 class="mainline-move move-verbose-edit" x-text="move.move_verbose"></h2>
        <textarea
          class="edit-move-text"
          x-model="moveState[index].text"
          rows="8"
        ></textarea>
        <div class="move-fen">
          <a
            title="View position at this move in Lichess analysis board"
            :href="variationData.analysis_url + (index + 1)"
            target="_blank"
            rel="noopener"
            x-text="move.fen"
          ></a>
        </div>
      </div>
      <div class="edit-move-other-container">
        <select
          :value="move.shared_move_id"
          @change="move.shared_move_id = $event.target.value; updateSharedMoveState(index)"
          :class="{ 'shared-selected': move.shared_move_id && !isNaN(parseInt(move.shared_move_id)) }"
        >
          <template x-for="item in move.shared_dropdown" :key="item.value">
            <option
              :value="String(item.value)"
              x-text="item.label"
              :selected="item.value === move.shared_move_id"
            ></option>
          </template>
        </select>
        <select class="annotation" x-model="moveState[index].annotation">
          <template x-for="[key, value] in Object.entries(variationData.annotations)">
            <option
              :value="key"
              x-text="value"
              :selected="key === moveState[index].annotation"
            ></option>
          </template>
        </select>
        <input
          type="text"
          class="move-alt"
          x-model="moveState[index].alt"
          placeholder="Alternative move"
          @blur="validateAltMoves(index, 'alt', $event)"
        />
        <input
          type="text"
          class="move-alt-fail"
          x-model="moveState[index].alt_fail"
          placeholder="Alt move fail"
          @blur="validateAltMoves(index, 'alt_fail', $event)"
        />
        <div>
          <button
            title="Save"
            class="icon-save icon-button"
            :class="{
                'save-success': move.saved === 'success',
                'save-pending': move.saved === 'pending',
                'save-error': move.saved === 'error'
              }"
            @click.prevent="saveFromMove(index)"
          ></button>
          <button
            title="Previous Move"
            class="icon-back icon-button"
            @click.prevent="scrollToMoveBlock(index - 1)"
          ></button>
          <button
            title="Next Move"
            class="icon-forward icon-button"
            @click.prevent="scrollToMoveBlock(index + 1)"
          ></button>
          <!-- utterly defeated trying to scroll to top on mobile; will use this for now -->
          <button
            title="Go to Top"
            class="icon-up icon-button"
            @click.prevent="scrollToMoveBlock(0)"
          ></button>
        </div>
        <div id="edit-move-other-links">
          <a
            title="View variation at this move"
            :href="'/variation/' + variationData.variation_id + '/?idx=' + index"
            >üìñ view</a
          >
          <template x-if="move.matching_move_count > 1 || move.shared">
            <a
              :href="'/edit-shared-move/?san=' + encodeURIComponent(move.san) + '&fen=' + move.fen + '&color=' + variationData.color + '&variation_id=' + variationData.variation_id"
              title="Shared Move Editor"
              x-text="'=' + move.matching_move_count"
            ></a>
          </template>
          <a
            :href="'/admin/chesser/move/' + move.move_id + '/change/'"
            title="Edit move in Django admin"
            target="_blank"
            rel="noopener"
            x-text="'#' + move.move_id"
          ></a>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- Safe JSON embed using Django json_script (avoids escapejs pitfalls) -->
{{ variation_data|json_script:"variation-data" }}
<script>
  window.variationData = window.readJsonScript("variation-data");
  console.log("variationData:", window.variationData);
</script>

<script type="module">
  import { editApp } from "{% static 'js/edit.js' %}";

  window.editApp = editApp;

  document.addEventListener("alpine:init", () => {
    Alpine.data("editApp", editApp);
  });
</script>
{% endblock %}
