{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit</title>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
    <link href="{% static 'css/chesser.css' %}" rel="stylesheet" />
  </head>
  <body x-data="editApp()" x-init="initEditor()">
    <div class="button-container">
      <button @click="window.location.href='/'" title="Home">ğŸ ï¸</button>
      <button @click="window.location.href='/review/'" title="Review">ğŸ“</button>
      <button @click="window.location.href='/import/'" title="Import">ğŸ“¥ï¸</button>
      <button @click="saveVariation()" title="Save">ğŸ’¾</button>
      <button
        @click="window.location.href='/variation/' + variationData.variation_id + '/'"
        title="View"
      >
        ğŸ“šï¸
      </button>
    </div>

    <div id="edit-variation-info">
      <div>
        <a
          :href="'/course/' + variationData.course_id + '/chapter/' + variationData.chapter_id + '/'"
          x-text="variationData.chapter"
        ></a>
        â€¢
        <a
          :href="'/admin/chesser/variation/' + variationData.variation_id + '/change/'"
          target="_blank"
          x-text="'#' + variationData.variation_id"
        ></a>
        â€¢
        <a :href="'/review/' + variationData.variation_id + '/'">extra study</a> âœï¸
      </div>

      <div>
        <label for="variation-title">Variation Name:</label>
        <input type="text" id="variation-title" x-model="variationData.title" />
      </div>
      <div>
        <label for="start-move">Start Move:</label>
        <input type="number" id="start-move" x-model="variationData.start_move" />
      </div>
      <div x-text="variationData.main_line"></div>
    </div>

    <!-- Generate multiple boards dynamically -->
    <div id="boards-container">
      <template x-for="(move, index) in variationData.moves" :key="index">
        <!-- move.fen is set in js; make sure it is initialized here -->
        <div class="move-block" x-init="move.fen = move.fen || ''">
          <div class="edit-board" :id="'edit-board-' + index"></div>
          <div class="move-text-container">
            <div class="move-verbose" x-text="move.move_verbose"></div>
            <textarea
              class="move-text"
              x-model="move.text"
              rows="10"
              cols="60"
            ></textarea>
            <div class="move-fen">
              <a
                :href="'https://lichess.org/analysis/standard/' + move.fen.replace(/ /g, '_') + '?color=' + variationData.color"
                target="_blank"
                x-text="move.fen"
              ></a>
            </div>
          </div>
          <div class="move-other-container">
            <select class="annotation" x-model="move.annotation">
              <template
                x-for="[key, value] in Object.entries(variationData.annotations)"
              >
                <option
                  :value="key"
                  x-text="value"
                  :selected="key === move.annotation"
                ></option>
              </template>
            </select>
            <input
              type="text"
              class="move-alt"
              x-model="move.alt"
              placeholder="Alternative move"
              @blur="validateAltMoves(index, 'alt')"
            />
            <input
              type="text"
              class="move-alt-fail"
              x-model="move.alt_fail"
              placeholder="Alt move fail"
              @blur="validateAltMoves(index, 'alt_fail')"
            />
          </div>
        </div>
      </template>
    </div>

    {% include "includes/landscape_overlay.html" %}

    <script>
      window.variationData = JSON.parse("{{ variation_data|escapejs }}");
      console.log("variationData:", window.variationData); // Debugging
    </script>

    <script type="module">
      import { editApp } from "{% static 'js/edit.js' %}";
      window.editApp = editApp;
      document.addEventListener("alpine:init", () => {
        Alpine.data("editApp", editApp);
      });
    </script>

    <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
  </body>
</html>
