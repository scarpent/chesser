{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit</title>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
    <link href="{% static 'css/chesser.css' %}" rel="stylesheet" />
  </head>
  <body x-data="editApp()" x-init="initEditor()">
    <div class="button-container">
      <button
        title="Home"
        @click="window.location.href='/'"
        class="icon-home icon-button"
      ></button>
      <button
        title="Review"
        @click="window.location.href='/review/'"
        class="icon-review icon-button"
      ></button>
      <button
        title="Import"
        @click="window.location.href='/import/'"
        class="icon-import icon-button"
      ></button>
      <button
        title="Save"
        @click="saveVariation()"
        class="icon-save icon-button"
      ></button>
      <button
        title="View"
        @click="window.location.href='/variation/' + variationData.variation_id + '/'"
        class="icon-variation icon-button"
      ></button>
    </div>

    <div id="edit-variation-info" class="form-standard">
      <div>
        <a
          :href="'/course/' + variationData.course_id + '/chapter/' + variationData.chapter_id + '/'"
          x-text="variationData.chapter"
        ></a>
        •
        <a
          :href="'/admin/chesser/variation/' + variationData.variation_id + '/change/'"
          target="_blank"
          x-text="'#' + variationData.variation_id"
        ></a>
        •
        <a :href="'/review/' + variationData.variation_id + '/'">extra study</a> ✏️
      </div>

      <div>
        <label for="variation-title">Variation Title:</label>
        <input
          type="text"
          id="variation-title"
          x-model="variationData.title"
          class="variation-title-input"
        />
      </div>
      <div>
        <label for="start-move">Start Move:</label>
        <input
          type="text"
          id="start-move"
          x-model="variationData.start_move"
          class="start-move-input"
        />
      </div>
      <div id="edit-mainline-moves" x-text="variationData.mainline"></div>
    </div>

    <!-- Generate multiple boards dynamically -->
    <div id="boards-container" class="form-standard">
      <template x-for="(move, index) in variationData.moves" :key="index">
        <!-- move.fen is set in js; make sure it is initialized here -->
        <div class="move-block" x-init="move.fen = move.fen || ''">
          <div class="edit-board" :id="'edit-board-' + index"></div>
          <div class="move-text-container">
            <h2 class="mainline-move move-verbose-edit" x-text="move.move_verbose"></h2>
            <textarea
              class="move-text"
              x-model="move.text"
              rows="10"
              cols="60"
            ></textarea>
            <div class="move-fen">
              <a
                :href="variationData.analysis_url + (index + 1)"
                target="_blank"
                x-text="move.fen"
              ></a>
            </div>
          </div>
          <div class="move-other-container">
            <select class="annotation" x-model="move.annotation">
              <template
                x-for="[key, value] in Object.entries(variationData.annotations)"
              >
                <option
                  :value="key"
                  x-text="value"
                  :selected="key === move.annotation"
                ></option>
              </template>
            </select>
            <input
              type="text"
              class="move-alt"
              x-model="move.alt"
              placeholder="Alternative move"
              @blur="validateAltMoves(index, 'alt')"
            />
            <input
              type="text"
              class="move-alt-fail"
              x-model="move.alt_fail"
              placeholder="Alt move fail"
              @blur="validateAltMoves(index, 'alt_fail')"
            />
          </div>
        </div>
      </template>
    </div>

    {% include "includes/landscape_overlay.html" %}

    <script>
      window.variationData = JSON.parse("{{ variation_data|escapejs }}");
      console.log("variationData:", window.variationData); // Debugging
    </script>

    <script type="module">
      import { editApp } from "{% static 'js/edit.js' %}";
      window.editApp = editApp;
      document.addEventListener("alpine:init", () => {
        Alpine.data("editApp", editApp);
      });
    </script>

    <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
  </body>
</html>
