{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variation</title>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
    <link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
    <link href="{% static 'css/chesser.css' %}" rel="stylesheet" />
  </head>
  <body
    x-data="variationApp()"
    x-init="initVariation()"
    @keydown.window="handleKeyNavigation($event)"
  >
    <div id="outer-container">
      <div id="board-container">
        <div id="resizable-board">
          <div id="board"></div>
          <div id="resize-handle"></div>
        </div>
        <div class="button-container">
          <button @click="previousMainlineMove()" title="Mainline Back">‚¨ÖÔ∏è</button>
          <button @click="nextMainlineMove()" title="Mainline Forward">‚û°Ô∏è</button>
          <button title="Subvariation Back">‚ÜñÔ∏è</button>
          <button title="Subvariation Forward">‚ÜòÔ∏è</button>
        </div>
        <div class="button-container">
          <button @click="window.location.href='/review/'" title="Review">üöÄ</button>
          <button
            @click="window.open('https://lichess.org/analysis/standard/' + chess.fen().replace(/ /g, '_') + '?color=' + variationData.color, '_blank')"
            title="Lichess analysis board"
          >
            üîçÔ∏è
          </button>
          <button
            @click="window.location.href='/edit/' + variationData.variation_id"
            title="Edit"
          >
            ‚öôÔ∏è
          </button>
          <button @click="window.location.href='/'" title="Home">üè†Ô∏è</button>
        </div>
        <div class="info-container">
          <div class="chapter-title">
            <span x-text="variationData.chapter"></span>
            <span> ‚û§ </span>
            <span x-text="variationData.title"></span>
          </div>
          <div x-text="variationData.mainline"></div>
          <div x-text="'Level ‚û§ ' + variationData.level"></div>
        </div>
      </div>
      <div id="variation-text">
        <h3 class="variation-mainline">
          <span class="move mainline-move" data-index="0">1.e4!</span>
          <span class="move mainline-move" data-index="1">Nc6</span>
        </h3>
        <p>
          The Nimzovich Defence. It is not that bad if you use it just as a
          transpositional tool to reach 1 e4 e5 positions - the independent lines,
          however, are not that reliable for Black, or just downright bad.
        </p>
        <h3 class="variation-mainline">
          <span class="move mainline-move" data-index="2">2.Nf3</span>
        </h3>
        <p>Instead, 2.d4 is good as well. But 2.Nf3 is logical and easier to handle.</p>
        <p>
          How might that work? Well, let's see:
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppppppp/2n5/8/3PP3/8/PPP2PPP/RNBQKBNR b KQkq - 0 2"
            data-index="0"
            >2.d4</span
          >
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppp1ppp/2n5/4p3/3PP3/8/PPP2PPP/RNBQKBNR w KQkq - 0 3"
            data-index="1"
            >e5</span
          >
          We could transpose to the Scotch Game here, but engine says to pick up the
          d-pawn. Masters prefer dxe5 and plebs d5. (Engine likes both, but d5 slightly
          better.)
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppp1ppp/2n5/3Pp3/4P3/8/PPP2PPP/RNBQKBNR b KQkq - 0 3"
            data-index="2"
            >3.d5</span
          >
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/ppppnppp/8/3Pp3/4P3/8/PPP2PPP/RNBQKBNR w KQkq - 1 4"
            data-index="3"
            >Nce7</span
          >
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/ppppnppp/8/3Pp3/4P3/5N2/PPP2PPP/RNBQKB1R b KQkq - 2 4"
            data-index="4"
            >4.Nf3</span
          >
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppp1ppp/6n1/3Pp3/4P3/5N2/PPP2PPP/RNBQKB1R w KQkq - 3 5"
            data-index="5"
            >Ng6</span
          >
          White is better and scores well with h4. With other moves, Black is doing
          better in pleb games, and it's no surprise because these positions seem hard
          to play in practice.
        </p>
        <p>
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppppppp/2n5/8/4P3/2N5/PPPP1PPP/R1BQKBNR b KQkq - 2 2"
            data-index="6"
            >2.Nc3</span
          >
          <span
            class="move subvar-move"
            data-fen="r1bqkbnr/pppp1ppp/2n5/4p3/4P3/2N5/PPPP1PPP/R1BQKBNR w KQkq - 0 3"
            data-index="7"
            >e5</span
          >
          Did someone order a Vienna?
        </p>
        <h3 class="variation-mainline">
          <span class="move mainline-move" data-index="3">2...d5</span>
        </h3>
        <p>Scandi style play - it is very questionable though.</p>
        <h3 class="variation-mainline">
          <span class="move mainline-move" data-index="4">3.exd5</span>
          <span class="move mainline-move" data-index="5">Qxd6</span>
          <span class="move mainline-move" data-index="6">4.Nc3</span>
          <span class="move mainline-move" data-index="7">Qh5?</span>
          <span class="move mainline-move" data-index="8">5.Nb5!</span>
        </h3>
        <p>
          Quite an embarrassing moment for Black - now ...Kd8 is the only move and it is
          not pretty.
        </p>
      </div>
    </div>

    <!-- Pass variationData safely to JavaScript -->
    <script>
      window.variationData = JSON.parse("{{ variation_data|escapejs }}");
      console.log("variation data loaded:", window.variationData);
    </script>

    <script type="module">
      import { variationApp } from "{% static 'js/variation.js' %}";
      window.variationApp = variationApp;
      console.log("variationApp loaded");

      document.addEventListener("alpine:init", () => {
        console.log("alpine.js initializing");
        Alpine.data("variationApp", variationApp);
      });
    </script>
    <script src="{% static 'js/resize.js' %}"></script>

    <!-- Load alpine.js LAST -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"
    ></script>
  </body>
</html>
