<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block title %}Edit{% endblock %}
{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/variation.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/analysis.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/save.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/back.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/forward.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/up.svg' %}" as="image" />
<link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
{% endblock %}

<!-- prettier-ignore -->
{% block content %}
<body
  x-data="editApp()"
  x-init="initEditor(); document.title = 'Move: ' + moveData.move_verbose"
  x-cloak
>
  <div class="button-container" style="margin-top: 15px">
    <button
      title="Home"
      @click="window.location.href = '/'"
      class="image-button home-button button-round"
    >
      <img src="{% static 'images/chesser-logo-192x192.png' %}" alt="Chesser Logo" />
    </button>
    <button
      title="Review"
      @click="window.location.href='/review/'"
      class="icon-review icon-button"
    ></button>
    <button
      title="Import"
      @click="window.location.href='/import/'"
      class="icon-import icon-button"
    ></button>
    <button
      title="Edit"
      @click="window.location.href='/edit/' + moveData.variation_id + '/'"
      class="icon-edit icon-button"
    ></button>
    <button
      title="Lichess analysis board"
      @click="window.open('https://lichess.org/analysis/standard/' +
      moveData.fen.replace(/ /g, '_') + '?color=' + moveData.color, '_blank')"
      class="icon-analysis icon-button"
    ></button>
    <button
      title="Save"
      @click="saveVariation()"
      class="icon-save icon-button"
    ></button>
  </div>

  <div id="edit-variation-info" class="form-standard">
    <div>
      <a
        :href="buildAdminMatchingSharedMovesLink()"
        target="_blank"
        title="Show all shared moves matching SAN/FEN"
        >shared moves</a
      >
      â€¢
      <a
        :href="buildAdminMatchingMovesLink()"
        target="_blank"
        title="Show all moves matching SAN/FEN"
        >regular moves</a
      >
    </div>

    <div>
      <span x-text="moveData.fen" class="move-fen"></span>
      <h2 class="mainline-move move-verbose-edit" x-text="moveData.move_verbose"></h2>
    </div>
  </div>

  <h3 style="margin-top: 0">Shared Moves</h3>
  <!-- Generate multiple boards dynamically -->
  <div id="boards-container" class="form-standard">
    <template x-for="(move, index) in moveData.shared_moves" :key="index">
      <div class="move-block" :id="'move-block-' + index">
        <div class="edit-board" :id="'edit-board-' + index"></div>
        <div class="edit-move-text-container">
          <textarea class="edit-move-text" x-model="move.text" rows="12"></textarea>
        </div>
        <div class="edit-move-other-container">
          <select class="annotation" x-model="move.annotation">
            <template x-for="[key, value] in Object.entries(moveData.annotations)">
              <option
                :value="key"
                x-text="value"
                :selected="key === move.annotation"
              ></option>
            </template>
          </select>
          <input
            type="text"
            class="move-alt"
            x-model="move.alt"
            placeholder="Alternative move"
          />
          <input
            type="text"
            class="move-alt-fail"
            x-model="move.alt_fail"
            placeholder="Alt move fail"
          />
          <div id="edit-move-other-links">
            <span
              x-text="move.linked_move_ids.length + ' move' + (move.linked_move_ids.length === 1 ? '' : 's')"
            ></span>
            <a
              :href="'/admin/chesser/sharedmove/' + move.id + '/change/'"
              target="_blank"
              x-text="'#' + move.id"
            ></a>
          </div>
        </div>
      </div>
    </template>
    <h3 style="margin-top: 0">Grouped Moves</h3>
  </div>

  <!-- prettier-ignore -->
  {% include "includes/landscape_overlay.html" %}
  {% include "includes/service_worker_register.html" %}

  <script>
    window.variationData = JSON.parse("{{ variation_data|escapejs }}");
    window.moveData = JSON.parse("{{ move_data|escapejs }}");
    console.log("variationData:", window.variationData);
    console.log("moveData:", window.moveData);
  </script>

  <!-- caching bugbear in dev calls for this prod redundant cache buster -->
  <script type="module">
    import { editApp } from "{% static 'js/edit-shared.js' %}?v={{ BUILD_TIMESTAMP }}";
    window.editApp = editApp;
    document.addEventListener("alpine:init", () => {
      Alpine.data("editApp", editApp);
    });
  </script>

  <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
</body>
{% endblock %}
