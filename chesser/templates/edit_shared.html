<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block title %}Edit{% endblock %}
{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/edit.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/analysis.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/save.svg' %}" as="image" />
<link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.brown.css' %}" rel="stylesheet" />
<link href="{% static 'chessground/chessground.fantasy.css' %}" rel="stylesheet" />
{% endblock %}

<!-- prettier-ignore -->
{% block content %}
<body
  x-data="editApp()"
  x-init="initEditor(); document.title = 'Move: ' + moveData.move_verbose"
  x-cloak
>
  <div class="button-container" style="margin-top: 15px">
    <button
      title="Home"
      @click="window.location.href = '/'"
      class="image-button home-button button-round"
    >
      <img src="{% static 'images/chesser-logo-192x192.png' %}" alt="Chesser Logo" />
    </button>
    <button
      title="Review"
      @click="window.location.href='/review/'"
      class="icon-review icon-button"
    ></button>
    <button
      title="Import"
      @click="window.location.href='/import/'"
      class="icon-import icon-button"
    ></button>
    <button
      title="Edit"
      @click="window.location.href='/edit/' + moveData.variation_id + '/'"
      class="icon-edit icon-button"
    ></button>
    <button
      title="Lichess analysis board"
      @click="window.open('https://lichess.org/analysis/standard/' +
      moveData.fen.replace(/ /g, '_') + '?color=' + moveData.color, '_blank')"
      class="icon-analysis icon-button"
    ></button>
    <button
      title="Save"
      @click="saveSharedMove()"
      class="icon-save icon-button"
    ></button>
  </div>

  <div id="edit-variation-info" class="form-standard">
    <div>
      admin:
      <a
        :href="buildAdminMatchingSharedMovesLink()"
        target="_blank"
        title="Show all shared moves matching SAN/FEN"
        >shared</a
      >
      ‚Ä¢
      <a
        :href="buildAdminMatchingMovesLink()"
        target="_blank"
        title="Show all moves matching SAN/FEN"
        >moves</a
      >
    </div>

    <div>
      <span x-text="moveData.fen" class="move-fen"></span>
      <h2 class="mainline-move move-verbose-edit" x-text="moveData.move_verbose"></h2>
    </div>
  </div>

  <div id="boards-container" class="form-standard" style="margin-bottom: 200px">
    <h3 style="margin: 0 0 0 10px">Shared</h3>
    <template x-for="(move, index) in moveData.shared_moves" :key="index">
      <div class="move-block" :id="'move-block-' + index">
        <div class="edit-board" :id="'edit-board-' + index"></div>
        <div class="edit-move-text-container">
          <textarea class="edit-move-text" x-model="move.text" rows="12"></textarea>
        </div>
        <div class="edit-move-other-container">
          <select class="annotation" x-model="move.annotation">
            <template x-for="[key, value] in Object.entries(moveData.annotations)">
              <option
                :value="key"
                x-text="value"
                :selected="key === move.annotation"
              ></option>
            </template>
          </select>
          <input
            type="text"
            class="move-alt"
            x-model="move.alt"
            placeholder="Alternative move"
          />
          <input
            type="text"
            class="move-alt-fail"
            x-model="move.alt_fail"
            placeholder="Alt move fail"
          />
          <div id="edit-move-other-links">
            <span
              x-text="move.linked_move_ids.length + ' move' + (move.linked_move_ids.length === 1 ? '' : 's')"
            ></span>
            <a
              :href="'/admin/chesser/sharedmove/' + move.id + '/change/'"
              target="_blank"
              x-text="'#' + move.id"
            ></a>
          </div>
        </div>
      </div>
    </template>

    <h3 style="margin: 0 0 0 10px">Grouped</h3>
    <template x-for="(move, index) in moveData.move_groups" :key="'grouped-' + index">
      <div class="move-block" :id="'grouped-move-block-' + index">
        <div class="grouped-text-container">
          <div class="grouped-inline-header">
            <span x-text="'#' + (index + 1)" class="grouped-move-num"></span>
            <select x-model="move.shared_move_id" class="grouped-move-select">
              <template x-for="item in move.shared_dropdown" :key="item.value">
                <option
                  :value="String(item.value)"
                  x-text="item.label"
                  :selected="item.value === move.shared_move_id"
                ></option>
              </template>
            </select>
            <a
              :href="buildAdminMatchingMovesLink(move)"
              target="_blank"
              title="Show all shared moves matching SAN/FEN/shared values"
              x-text="move.move_ids.length + ' move' + (move.move_ids.length === 1 ? '' : 's')"
            ></a>
          </div>
          <div class="grouped-attributes">
            <span
              x-text="'ann: ' + (move.annotation && move.annotation !== 'none' ? move.annotation + ' üü¢' : '‚ö™Ô∏è')"
            ></span>
            <span x-text="'alt: ' + (move.alt ? move.alt + ' üü¢': '‚ö™Ô∏è')"></span>
            <span
              x-text="'alt fail: ' + (move.alt_fail ? move.alt_fail + ' üü¢' : '‚ö™Ô∏è')"
            ></span>
            <template x-if="move.shapes && move.shapes.length > 0">
              <a href="#" @click.prevent="showShapesOverlay(move)">shapes üü¢</a>
            </template>
            <template x-if="!move.shapes || move.shapes.length === 0">
              <span>shapes ‚ö™Ô∏è</span>
            </template>
          </div>

          <pre class="grouped-move-text" x-text="move.text"></pre>
        </div>

        <div class="grouped-move-other-container">
          <span x-text="move.example_variation.title" class="grouped-move-title"></span>
          <button
            @click="updateSharedMoveLinkForGroup(move, index)"
            class="link-button"
            x-text="Number.isInteger(+move.shared_move_id) ? 'Link moves to #' + move.shared_move_id : 'Unlink shared move'"
          ></button>
          <button
            :class="Number.isInteger(+move.shared_move_id) ? '' : 'invisible-placeholder'"
            @click="confirmAndUpdateGroup(move)"
            class="link-button"
          >
            Sync shared values to moves
          </button>
          <div class="grouped-variation-links">
            vars:
            <template x-for="(var_id, idx) in move.variation_ids">
              <template x-if="idx < 5">
                <a :href="'/variation/' + var_id + '/'">
                  <span
                    x-text="var_id + (idx < Math.min(move.variation_ids.length, 5) - 1 ? ', ' : '')"
                  ></span>
                </a>
              </template>
            </template>
            <template x-if="move.variation_ids.length > 5">
              <span>...</span>
            </template>
          </div>
        </div>
      </div>
    </template>
  </div>

  <div x-show="overlayVisible" class="grouped-overlay-backdrop" @click="closeOverlay">
    <div class="grouped-overlay-box" @click.stop>
      <div id="overlay-board" style="width: 300px; height: 300px"></div>
    </div>
  </div>

  <!-- prettier-ignore -->
  {% include "includes/landscape_overlay.html" %}
  {% include "includes/service_worker_register.html" %}

  <script>
    window.moveData = JSON.parse("{{ move_data|escapejs }}");
    console.log("moveData:", window.moveData);
  </script>

  <!-- caching bugbear in dev calls for this prod redundant cache buster -->
  <script type="module">
    import { editApp } from "{% static 'js/edit-shared.js' %}?v={{ BUILD_TIMESTAMP }}";
    window.editApp = editApp;
    document.addEventListener("alpine:init", () => {
      Alpine.data("editApp", editApp);
    });
  </script>

  <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
</body>
{% endblock %}
