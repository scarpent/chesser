<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block title %}Edit{% endblock %}
{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/variation.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/edit.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/analysis.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/save.svg' %}" as="image" />
<link href="{% static 'chessground/chessground.base.css' %}" rel="stylesheet" />
<link
  href="{% static 'chessground/chessground.'|add:CHESS_BOARD_COLOR|add:'.css' %}"
  rel="stylesheet"
/>
<link
  href="{% static 'chessground/chessground.'|add:CHESS_PIECE_SET|add:'.css' %}"
  rel="stylesheet"
/>
<link href="{% static 'chessground/chessground.overrides.css' %}" rel="stylesheet" />
{% endblock %}

<!-- prettier-ignore -->
{% block content %}
<body
  x-data="editApp()"
  x-init="initEditor(); document.title = 'Move: ' + moveData.move_verbose"
  x-cloak
>
  {% include "includes/loading_overlay.html" %}{% if IS_DEMO %}
  <div class="demo-banner">üß™ <b>Demo mode</b> ‚Äî changes are not saved</div>
  {% endif %}

  <div class="button-container" style="margin-top: 15px">
    <button
      title="Home"
      @click="window.navigateWithSpinner('/')"
      class="image-button home-button button-round"
    >
      <img src="{% static 'images/chesser-logo-192x192.png' %}" alt="Chesser Logo" />
    </button>
    <button
      title="Review"
      @click="window.navigateWithSpinner('/review/')"
      class="icon-review icon-button"
    ></button>
    <button
      title="Import"
      @click="window.navigateWithSpinner('/import/')"
      class="icon-import icon-button"
    ></button>
    <button
      title="View"
      @click="window.navigateWithSpinner('/variation/' + moveData.variation_id + '/?idx=' + groupedMoveSequence())"
      class="icon-variation icon-button"
    ></button>
    <button
      title="Edit"
      @click="window.navigateWithSpinner('/edit/' + moveData.variation_id + '/?idx=' + groupedMoveSequence())"
      class="icon-edit icon-button"
    ></button>
    <button
      title="Lichess analysis board"
      @click="window.open(moveData.analysis_url, '_blank', 'noopener')"
      class="icon-analysis icon-button"
    ></button>
    <button title="Save All" @click="saveAll()" class="icon-save icon-button"></button>
  </div>

  <div id="edit-variation-info" class="form-standard">
    <div>
      <a
        :href="moveData.fen"
        @click.prevent="copyFen"
        :title="'Copy FEN ' + moveData.fen"
        >fen</a
      >
      üìãÔ∏è ‚Ä¢ admin:
      <a
        :href="buildAdminMatchingSharedMovesLink()"
        target="_blank"
        rel="noopener"
        title="Show all shared moves matching SAN/FEN"
        >shared</a
      >
      ‚Ä¢
      <a
        :href="buildAdminMatchingMovesLink()"
        target="_blank"
        rel="noopener"
        title="Show all moves matching SAN/FEN"
        >moves</a
      >
    </div>

    <h2 class="mainline-move move-verbose-edit" x-text="moveData.move_verbose"></h2>
  </div>

  <div id="boards-container" class="form-standard" style="margin-bottom: 200px">
    <h3
      style="margin: 0 0 0 10px"
      x-text="'Shared (' + moveData.shared_moves.length + ')'"
    ></h3>
    <template x-for="(move, index) in moveData.shared_moves" :key="index">
      <div class="move-block" :id="'move-block-' + index">
        <div class="edit-board" :id="'edit-board-' + index"></div>
        <div class="edit-move-text-container">
          <textarea class="edit-move-text" x-model="move.text" rows="12"></textarea>
        </div>
        <div class="edit-move-other-container">
          <select class="annotation" x-model="move.annotation">
            <template x-for="[key, value] in Object.entries(moveData.annotations)">
              <option
                :value="key"
                x-text="value"
                :selected="key === move.annotation"
              ></option>
            </template>
          </select>
          <input
            type="text"
            class="move-alt"
            x-model="move.alt"
            placeholder="Alternative move"
          />
          <input
            type="text"
            class="move-alt-fail"
            x-model="move.alt_fail"
            placeholder="Alt move fail"
          />
          <span
            x-text="move.linked_move_ids.length + ' variation' + (move.linked_move_ids.length === 1 ? '' : 's')"
          ></span>
          <div>
            shared move:
            <a
              :href="'/admin/chesser/sharedmove/' + move.id + '/change/'"
              title="Edit Shared Move in Admin"
              target="_blank"
              rel="noopener"
              x-text="'#' + move.id"
            ></a>
          </div>
        </div>
      </div>
    </template>

    <h3
      style="margin: 0 0 0 10px"
      x-text="'Grouped (' + moveData.total_matching_moves + ')'"
    ></h3>
    <template x-for="(move, index) in moveData.move_groups" :key="'grouped-' + index">
      <div class="move-block" :id="'grouped-move-block-' + index">
        <div class="grouped-text-container">
          <div class="grouped-inline-header">
            <span x-text="'#' + (index + 1)" class="grouped-move-num"></span>
            <select x-model="move.shared_move_id" class="grouped-move-select">
              <template x-for="item in move.shared_dropdown" :key="item.value">
                <option
                  :value="String(item.value)"
                  x-text="item.label"
                  :selected="item.value === move.shared_move_id"
                ></option>
              </template>
            </select>
            <a
              :href="buildAdminMatchingMovesLink(move)"
              target="_blank"
              rel="noopener"
              title="Show all shared moves matching SAN/FEN/shared values"
              x-text="move.move_ids.length + ' variation' + (move.move_ids.length === 1 ? '' : 's')"
            ></a>
          </div>
          <div class="grouped-attributes">
            <span
              x-text="'ann: ' + (move.annotation && move.annotation !== 'none' ? move.annotation + ' üü†' : '‚ö™Ô∏è')"
            ></span>
            <span x-text="'alt: ' + (move.alt ? move.alt + ' üü†': '‚ö™Ô∏è')"></span>
            <span
              x-text="'alt fail: ' + (move.alt_fail ? move.alt_fail + ' üü†' : '‚ö™Ô∏è')"
            ></span>
            <template x-if="move.shapes && move.shapes.length > 0">
              <a href="#" @click.prevent="showShapesOverlay(move)">shapes üü†</a>
            </template>
            <template x-if="!move.shapes || move.shapes.length === 0">
              <span>shapes ‚ö™Ô∏è</span>
            </template>
          </div>

          <pre class="grouped-move-text" x-text="move.text"></pre>
        </div>

        <div class="grouped-move-other-container">
          <span
            x-text="(move.variation_ids.length > 1 ? 'e.g. ' : '') + move.example_variation.title"
            class="grouped-move-title"
          ></span>
          <div class="grouped-variation-links">
            variations:
            <template x-for="(var_id, idx) in move.variation_ids">
              <template x-if="idx < 3">
                <a :href="'/variation/' + var_id + '/?idx=' + groupedMoveSequence()">
                  <span
                    x-text="'#' + var_id + (idx < Math.min(move.variation_ids.length, 3) - 1 ? ', ' : '')"
                  ></span>
                </a>
              </template>
            </template>
            <template x-if="move.variation_ids.length > 3">
              <span>...</span>
            </template>
          </div>
          <div
            style="margin: 8px 0"
            :class="Number.isInteger(+move.shared_move_id) ? '' : 'invisible-placeholder'"
          >
            <label>
              <!-- consider selecting by default? but that could be an unwelcome surprise behavior -->
              <input type="checkbox" x-model="move.sync_shared_values_to_moves" />
              Sync shared values
              <span x-text="move.in_sync ? 'üü¢' : 'üü°'"></span>
            </label>
          </div>
        </div>
      </div>
    </template>
  </div>

  <div x-show="overlayVisible" class="grouped-overlay-backdrop" @click="closeOverlay">
    <div class="grouped-overlay-box" @click.stop>
      <div id="overlay-board" style="width: 300px; height: 300px"></div>
    </div>
  </div>

  <!-- prettier-ignore -->
  {% include "includes/landscape_overlay.html" %}
  {% include "includes/service_worker_register.html" %}

  <script>
    window.moveData = JSON.parse("{{ move_data|escapejs }}");
    console.log("moveData:", window.moveData);
  </script>

  <script type="module">
    import { editApp } from "{% static 'js/edit-shared.js' %}";
    import { navigateWithSpinner } from "{% static 'js/loading.js' %}";

    window.editApp = editApp;
    window.navigateWithSpinner = navigateWithSpinner;

    document.addEventListener("alpine:init", () => {
      Alpine.data("editApp", editApp);
    });
  </script>

  <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
</body>
{% endblock %}
