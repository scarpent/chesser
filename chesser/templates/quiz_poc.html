{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz POC</title>
    <link
      href="{% static 'chessground/chessground.base.css' %}"
      rel="stylesheet"
    />
    <link
      href="{% static 'chessground/chessground.brown.css' %}"
      rel="stylesheet"
    />
    <link
      href="{% static 'chessground/chessground.fantasy.css' %}"
      rel="stylesheet"
    />
    <style>
      #board {
        width: 100%;
        /* Responsive board */
        max-width: 450px;
        height: 450px;
        margin: 0 auto;
      }
    </style>
  </head>

  <body x-data="chessApp()" x-init="initChessground()">
    <div id="board"></div>
    <div x-text="status" style="margin-top: 20px"></div>
    <div x-text="fennel" style="margin-top: 20px"></div>

    <!-- Load Chessground and Chess.js as ES modules -->
    <script type="module">
      import { Chessground } from "https://cdn.jsdelivr.net/npm/chessground@9.1.1/dist/chessground.min.js";
      import { Chess } from "https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/esm/chess.js";
      window.Chessground = Chessground;
      window.Chess = Chess;
    </script>

    <!-- Define chessApp BEFORE Alpine.js initializes -->
    <script>
      function chessApp() {
        return {
          board: null,
          chess: null,
          status: "Ready",
          quizData: JSON.parse("{{ quiz_data|escapejs }}"),
          currentQuizIndex: 0,
          initChessground() {
            const boardElement = document.getElementById("board");
            if (boardElement && window.Chessground && window.Chess) {
              this.chess = new window.Chess();

              // chess.js first so toDests() works
              this.chess.load(this.quizData.moves[this.currentQuizIndex].fen);
              this.board = window.Chessground(boardElement, {
                viewOnly: false,
                draggable: true,
                highlight: {
                  lastMove: true,
                  check: true,
                },
                orientation: "white",
                fen: this.quizData.moves[this.currentQuizIndex].fen, // Initial position from quiz data
                movable: {
                  color: "both", // Allow both white and black to move
                  free: false, // Only legal moves
                  dests: this.toDests(),
                  showDests: false,
                  events: {
                    after: this.handleMove.bind(this),
                  },
                },
              });

              this.fennel =
                "fennel: " + this.quizData.moves[this.currentQuizIndex].fen;

              //   console.log({
              //     message: "initChessground() // 10",
              //     board_fen: this.board.getFen(),
              //     chess_fen: this.chess.fen(),
              //     quiz_index: this.currentQuizIndex,
              //     quiz_data: this.quizData.moves[this.currentQuizIndex],
              //   });

              setTimeout(() => {
                this.currentQuizIndex++;

                const sanMove = this.quizData.moves[this.currentQuizIndex].move;
                const move = this.chess.move(sanMove);
                if (move) {
                  this.board.set({
                    fen: this.chess.fen(),
                    movable: {
                      dests: this.toDests(),
                    },
                    lastMove: [move.from, move.to],
                  });
                } else {
                  console.error("Invalid move: " + sanMove);
                }

                // this.chess.load(this.quizData.moves[this.currentQuizIndex].fen);
                // this.board.set({
                //   fen: this.quizData.moves[this.currentQuizIndex].fen,
                //   movable: {
                //     dests: this.toDests(),
                //   },
                // });
                this.fennel =
                  sanMove +
                  " âž¤ " +
                  this.quizData.moves[this.currentQuizIndex].fen;
                this.currentQuizIndex++;
              }, 1000); // 1-second delay

              this.status = "Chessboard Loaded!";
            } else {
              console.error("Chessground or Chess.js failed to load");
            }
          },
          toDests() {
            const dests = new Map();
            const squares =
              this.chess.SQUARES ||
              this.chess
                .board()
                .flatMap((row) =>
                  row.map((square) => (square ? square.square : null))
                )
                .filter(Boolean);
            squares.forEach((s) => {
              const ms = this.chess.moves({ square: s, verbose: true });
              if (ms.length)
                dests.set(
                  s,
                  ms.map((m) => m.to)
                );
            });
            return dests;
          },
          handleMove(orig, dest) {
            const move = this.chess.move({ from: orig, to: dest });
            if (move) {
              this.status = `Moved from ${orig} to ${dest}`;
              this.board.set({
                fen: this.chess.fen(),
                movable: {
                  dests: this.toDests(),
                },
              });

              console.log("this.chess.fen(): " + this.chess.fen());
              this.checkQuizMove(this.chess.fen());
            } else {
              this.status = `Illegal move from ${orig} to ${dest}`;
            }
          },
          checkQuizMove(fen) {
            const correctMove = this.quizData.moves[this.currentQuizIndex].move;
            const correctFen = this.quizData.moves[this.currentQuizIndex].fen;
            console.log("selectedFen: " + fen);
            console.log("correctFen: " + correctFen);

            if (fen === correctFen) {
              this.status = "Correct move! " + correctMove;
              this.fennel = this.quizData.moves[this.currentQuizIndex].fen;
            } else {
              this.status = "Incorrect move. Try again.";
              go_back_two = this.currentQuizIndex - 2; // reset to before last opposing move
              this.chess.load(this.quizData.moves[go_back_two].fen);
              this.board.set({
                fen: this.quizData.moves[go_back_two].fen,
                movable: {
                  dests: this.toDests(),
                },
              });
              setTimeout(() => {
                go_back_one = this.currentQuizIndex - 1;
                this.chess.load(this.quizData.moves[go_back_one].fen);
                this.board.set({
                  fen: this.quizData.moves[go_back_one].fen,
                  movable: {
                    dests: this.toDests(),
                  },
                });
                this.fennel = this.quizData.moves[this.currentQuizIndex].fen;
                // this.currentQuizIndex++;
              }, 250); // brief display to replay last opposing move

              //   this.board.set({
              //     fen: this.quizData.moves[previous_index].fen,
              //     movable: {
              //       dests: this.toDests(),
              //     },
              //   });
              //   this.fennel = this.quizData.moves[previous_index].fen;
            }
          },
        };
      }
    </script>

    <!-- Load Alpine.js LAST -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"
    ></script>
  </body>
</html>
