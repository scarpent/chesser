{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chesser</title>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <link href="{% static 'css/chesser.css' %}" rel="stylesheet" />
    <link rel="manifest" href="{% static 'manifest.json' %}" />
    <meta name="theme-color" content="#000000" />
  </head>
  <body x-data="homeApp()">
    <div class="course-covers" x-cloak>
      <a
        :href="homeData.nav.course_id == 1 ? '/course/2/' : '/course/1/'"
        class="course course-white"
        x-show="!homeData.nav.course_id || homeData.nav.course_id == 1"
      >
        <img src="{% static 'images/castle-white.png' %}" alt="Castle White" />
      </a>
      <a
        :href="homeData.nav.course_id == 2 ? '/course/1/' : '/course/2/'"
        class="course course-black"
        x-show="!homeData.nav.course_id || homeData.nav.course_id == 2"
      >
        <img src="{% static 'images/castle-black.png' %}" alt="Castle Black" />
      </a>
    </div>

    <div class="button-container" x-cloak>
      <button
        title="Home"
        @click="window.location.href='/'"
        class="icon-home icon-button"
      ></button>
      <button
        title="Stats"
        @click="alert('Stats TBD')"
        class="icon-stats icon-button"
      ></button>
      <button
        title="Review"
        @click="window.location.href='/review/'"
        class="icon-review icon-button big-icon"
      ></button>
      <button
        title="Import"
        @click="window.location.href='/import/'"
        class="icon-import icon-button"
      ></button>
      <button
        title="Random Extra Study"
        @click="goToRandomReview()"
        class="icon-random icon-button"
      ></button>
    </div>

    <div
      x-show="Object.keys(homeData.nav.courses).length > 0"
      class="courses-container"
      x-cloak
    >
      <h3 style="color: orange">
        üìöÔ∏è My Book (<span x-text="homeData.nav.courses_var_count"></span>) ‚û§
      </h3>
      <ul>
        <template x-for="course in homeData.nav.courses" :key="course.id">
          <li>
            <a :href="'/course/' + course.id + '/'" x-text="course.title"></a>
            (<span x-text="course.variation_count"></span>)
          </li>
        </template>
      </ul>
    </div>

    <div
      x-show="Object.keys(homeData.nav.chapters).length > 0"
      class="chapters-container"
      x-cloak
    >
      <h3>
        üìöÔ∏è <a href="/">My Book</a> ‚û§
        <span x-text="homeData.nav.course_title"></span>
        (<span x-text="homeData.nav.chapters_var_count"></span>)
      </h3>
      <ol>
        <template x-for="chapter in homeData.nav.chapters" :key="chapter.id">
          <li>
            <a
              :href="'/course/' + homeData.nav.course_id + '/chapter/' + chapter.id + '/'"
              x-text="chapter.title"
            ></a>
            (<span x-text="chapter.variation_count"></span>)
          </li>
        </template>
      </ol>
    </div>

    <div x-show="homeData.nav.chapter_id" class="variations-container" x-cloak>
      <h3>
        üìöÔ∏è <a href="/">My Book</a> ‚û§
        <a :href="'/course/' + homeData.nav.course_id + '/'"
          ><span x-text="homeData.nav.course_title"></span
        ></a>
        ‚û§
        <span x-text="homeData.nav.chapter_title"></span>
        (<span x-text="homeData.nav.variations.length"></span>)
      </h3>
      <ol>
        <template x-for="variation in homeData.nav.variations" :key="variation.id">
          <li>
            <div class="variations-list-info">
              <div>
                <a
                  :href="'/variation/' + variation.id + '/'"
                  x-text="variation.title"
                ></a>
              </div>
              <div style="text-align: right">
                <span
                  x-text="'S' + variation.start_move"
                  class="chapter-vars-review-info"
                ></span>
                ‚Ä¢
                <span
                  x-text="'L' + variation.level"
                  class="chapter-vars-review-info"
                ></span>
                ‚Ä¢
                <span
                  x-text="variation.time_since_last_review"
                  class="chapter-vars-review-info"
                ></span>
                ‚û§<span
                  x-text="variation.time_until_next_review"
                  class="chapter-vars-review-info"
                ></span>
              </div>
            </div>

            <span
              x-text="variation.mainline_moves_str"
              class="chapter-vars-mainline-moves"
            ></span>
          </li>
        </template>
      </ol>
      <template x-if="Object.keys(homeData.nav.variations).length === 0">
        <p>This chapter lacks variations.</p>
      </template>
    </div>

    <div
      id="next-due"
      x-data="nextDueTimer()"
      x-init="initCountdown()"
      x-text="label"
    ></div>

    <div class="reviews-levels-wrapper" x-cloak>
      <div class="reviews-levels-container">
        <div class="reviews-container">
          <h3>Upcoming Reviews</h3>
          <table>
            <thead>
              <tr>
                <th>When?</th>
                <th># Vars</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="timeframe in homeData.upcoming" :key="timeframe.label">
                <tr>
                  <td x-text="timeframe.label"></td>
                  <td x-text="timeframe.count"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <div class="levels-container">
          <h3>Current Levels</h3>
          <table class="current-levels">
            <thead>
              <tr>
                <th>Level</th>
                <th># Vars</th>
              </tr>
            </thead>
            <tbody>
              <template
                x-for="variation_level in homeData.levels"
                :key="variation_level.label"
              >
                <tr>
                  <td x-text="variation_level.label"></td>
                  <td x-text="variation_level.count"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="home-recently-wrapper">
      <div class="home-recently" x-cloak>
        <h3>Recently Reviewed</h3>
        <ul>
          <template x-for="review in homeData.recent" :key="review.variation_id">
            <li>
              <div class="home-recently-info">
                <div>
                  <span x-text="review.passed"></span>
                  <a
                    :href="'/variation/' + review.variation_id + '/'"
                    x-text="review.variation_title"
                  ></a>
                </div>
                <div>
                  (<span x-text="review.datetime"></span>, L<span
                    x-text="review.level"
                  ></span
                  >)
                </div>
              </div>
            </li>
          </template>
        </ul>
      </div>

      <template x-if="homeData.recently_added.length !== 0">
        <div class="home-recently" x-cloak>
          <h3>Recently Added</h3>
          <ul>
            <template
              x-for="review in homeData.recently_added"
              :key="review.variation_id"
            >
              <li>
                <div class="home-recently-info">
                  <div>
                    ‚û°Ô∏è
                    <a
                      :href="'/variation/' + review.variation_id + '/'"
                      x-text="review.variation_title"
                    ></a>
                  </div>
                  <div>
                    <span x-text="review.created_at"></span> ‚û§
                    <span x-text="review.next_review"></span>
                  </div>
                </div>
              </li>
            </template>
          </ul>
        </div>
      </template>
    </div>

    {% include "includes/landscape_overlay.html" %}

    <!-- Admin and Logout links side by side -->
    <div class="links-container" x-cloak>
      <!-- Admin link -->
      <a href="/admin/" class="admin-link" target="_blank">Admin</a>

      <!-- Logout form styled as a link -->
      <form method="POST" action="{% url 'logout' %}" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>

    <script>
      window.homeData = JSON.parse("{{ home_data|escapejs }}");
      console.log("homeData:", window.homeData);
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("homeApp", () => ({
          homeData: window.homeData,

          goToRandomReview() {
            const course = this.homeData.nav.course_id;
            const chapter = this.homeData.nav.chapter_id;
            let url = "/review/random/";

            const params = [];
            if (course) params.push(`course_id=${course}`);
            if (chapter) params.push(`chapter_id=${chapter}`);
            if (params.length) url += "?" + params.join("&");

            window.location.href = url;
          },
        }));
      });
    </script>

    <script>
      function nextDueTimer() {
        return {
          originalText: window.homeData.next_due,
          label: window.homeData.next_due,

          initCountdown() {
            const match = this.originalText.match(/Next: (\d+)s/);
            if (!match) return;

            let value = parseInt(match[1], 10);

            const tick = () => {
              if (value-- > 1) {
                this.label = `‚è∞ Next: ${value} üß®`;
                setTimeout(tick, 1000);
              } else {
                this.label = "‚è∞ Next: üí• Now!";
              }
            };

            tick();
          },
        };
      }
    </script>

    <script defer src="{% static 'alpine/cdn.min.js' %}"></script>
  </body>
</html>
