<!-- prettier-ignore -->
{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<link rel="preload" href="{% static 'icons/noto-emoji/review.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/stats.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/import.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/random.svg' %}" as="image" />
<link rel="preload" href="{% static 'icons/noto-emoji/puzzles.svg' %}" as="image" />
{% endblock %}

<!-- prettier-ignore -->
{% block body_attrs %}
x-data="homeApp()" x-init="initHome(); $store.loading.visible = false;"
{% endblock %}

{% block content %}
<!-- prettier-ignore -->
{% if IS_DEMO %}
<div class="demo-banner">üß™ <b>Demo mode</b> ‚Äî changes are not saved</div>
{% endif %}

<div class="course-covers" x-cloak>
  <button
    @click="window.navigateWithSpinner('/chapters/white/')"
    class="image-button course-white"
    title="White Openings"
  >
    <img src="{% static 'images/castle-white.jpg' %}" alt="Castle White" />
  </button>
  <button
    @click="window.navigateWithSpinner('/')"
    class="image-button home-button button-round"
    title="Home"
  >
    <img
      src="{% static 'images/chesser-logo-192x192.png' %}"
      alt="Chesser Logo"
      style="width: 85px; height: 85px"
    />
  </button>
  <button
    @click="window.navigateWithSpinner('/chapters/black/')"
    class="image-button course-black"
    title="Black Openings"
  >
    <img src="{% static 'images/castle-black.jpg' %}" alt="Castle Black" />
  </button>
</div>

<div class="button-container button-container-home" x-cloak>
  <button
    title="Stats"
    @click="window.open('/stats/', '_blank', 'noopener')"
    class="icon-stats icon-button icon-button-big-round"
  ></button>
  <button
    title="Review"
    @click="window.navigateWithSpinner('/review/')"
    class="icon-review icon-button icon-button-big-round"
  ></button>
  <button
    title="Import"
    @click="window.navigateWithSpinner('/import/')"
    class="icon-import icon-button icon-button-big-round"
  ></button>
</div>

<div x-show="homeData.nav.color === ''" class="courses-container" x-cloak>
  <h3>üìöÔ∏è My Book (<span x-text="homeData.nav.total_var_count"></span>) ‚û§</h3>
  <ul>
    <template x-for="color in homeData.nav.colors" :key="color.id">
      <li>
        <b>
          <a
            :href="'/chapters/' + color.title.toLowerCase() + '/'"
            x-text="color.title"
          ></a>
          (<span x-text="color.variation_count"></span>)
        </b>
      </li>
    </template>
  </ul>
</div>

<div
  x-show="Object.keys(homeData.nav.chapters).length > 0"
  class="chapters-container"
  x-cloak
>
  <h3>
    üìöÔ∏è <a href="/">My Book</a> ‚û§
    <span x-text="titleCase(homeData.nav.color)"></span>
    (<span x-text="homeData.nav.color_var_count"></span>)
  </h3>
  <ol>
    <template x-for="chapter in homeData.nav.chapters" :key="chapter.id">
      <li>
        <a
          :href="'/chapters/' + homeData.nav.color + '/' + chapter.id + '/'"
          x-text="chapter.title"
        ></a>
        (<span x-text="chapter.variation_count"></span>)
      </li>
    </template>
  </ol>
</div>

<div x-show="homeData.nav.chapter_id" class="variations-container" x-cloak>
  <h3>
    üìöÔ∏è <a href="/">My Book</a> ‚û§
    <a :href="'/chapters/' + homeData.nav.color + '/'"
      ><span x-text="titleCase(homeData.nav.color)"></span
    ></a>
    ‚û§
    <span x-text="homeData.nav.chapter_title"></span>
    (<span x-text="homeData.nav.variations.length"></span>)
  </h3>
  <ol>
    <template x-for="variation in homeData.nav.variations" :key="variation.id">
      <li :id="'var_' + variation.id">
        <div class="variations-list-info">
          <div>
            <span x-show="variation.is_intro">üìå</span>
            <a :href="'/variation/' + variation.id + '/'" x-text="variation.title"></a>
            <span
              x-show="variation.level === 0 || variation.level >= 9"
              x-text="variation.level === 0 ? 'üå±' : 'üå≥'"
            ></span>
          </div>
          <div style="text-align: right; padding-left: 20px">
            <span
              x-text="'S' + variation.start_move"
              class="chapter-vars-review-info"
            ></span>
            ‚Ä¢
            <span
              x-text="'L' + variation.level"
              class="chapter-vars-review-info"
            ></span>
            ‚Ä¢
            <span
              x-text="variation.time_since_last_review"
              class="chapter-vars-review-info"
            ></span>
            ‚û§<span
              x-text="variation.time_until_next_review"
              class="chapter-vars-review-info"
            ></span>
          </div>
        </div>

        <span
          x-html="variation.mainline_moves_html"
          class="chapter-vars-mainline-moves"
        ></span>
      </li>
    </template>
  </ol>
  <template x-if="Object.keys(homeData.nav.variations).length === 0">
    <p>This chapter lacks variations.</p>
  </template>
</div>

<div
  id="next-due"
  x-data="nextDueTimer()"
  x-init="initCountdown()"
  @next-due-refresh.window="refreshFromServer()"
  x-text="label"
></div>

<div class="reviews-levels-wrapper" x-cloak>
  <div class="reviews-levels-container">
    <div class="reviews-container">
      <h3>Upcoming Reviews</h3>
      <table>
        <thead>
          <tr>
            <th>When?</th>
            <th># Vars</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="timeframe in homeData.upcoming" :key="timeframe.label">
            <tr>
              <td x-text="timeframe.label"></td>
              <td x-text="timeframe.count"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="levels-container">
      <h3>Current Levels</h3>
      <table class="current-levels">
        <thead>
          <tr>
            <th>Level</th>
            <th># Vars</th>
          </tr>
        </thead>
        <tbody>
          <template
            x-for="variation_level in homeData.levels"
            :key="variation_level.label"
          >
            <tr>
              <td x-text="variation_level.label"></td>
              <td x-text="variation_level.count"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div
  class="button-container button-container-home"
  style="margin-top: 30px; margin-bottom: 30px"
  x-cloak
>
  <button
    title="Random Extra Study"
    @click="goToRandomReview()"
    class="icon-random icon-button icon-button-big-round"
  ></button>
  <button
    title="Lichess Puzzles"
    @click="window.open('https://lichess.org/training', '_blank', 'noopener')"
    class="icon-puzzles icon-button icon-button-big-round"
  ></button>
</div>

<div class="home-recently-wrapper">
  <div class="home-recently" x-cloak>
    <h3>Recently Reviewed</h3>
    <ul>
      <template x-for="review in homeData.recent" :key="review.id">
        <li>
          <div class="home-recently-info">
            <div>
              <span x-text="review.passed"></span>
              <a
                :href="'/variation/' + review.variation_id + '/'"
                x-text="review.variation_title"
              ></a>
            </div>
            <div>
              (<span x-text="review.datetime"></span>, L<span
                x-text="review.level"
              ></span
              >)
            </div>
          </div>
        </li>
      </template>
    </ul>
  </div>

  <template x-if="homeData.recently_added.length !== 0">
    <div class="home-recently" x-cloak>
      <h3>Recently Added</h3>
      <ul>
        <template
          x-for="variation in homeData.recently_added"
          :key="variation.variation_id"
        >
          <li>
            <div class="home-recently-info">
              <div>
                ‚û°Ô∏è
                <a
                  :href="'/variation/' + variation.variation_id + '/'"
                  x-text="variation.variation_title"
                ></a>
              </div>
              <div>
                <span x-text="variation.created_at"></span> ‚û§
                <span x-text="variation.next_review"></span>, L<span
                  x-text="variation.level"
                ></span>
              </div>
            </div>
          </li>
        </template>
      </ul>
    </div>
  </template>
</div>

<!-- prettier-ignore -->
{% include "includes/landscape_overlay.html" %}
  {% include "includes/service_worker_register.html" %}

<div class="links-container" x-cloak>
  <!-- Admin link -->
  <a href="/admin/" target="_blank" rel="noopener">Admin</a>

  <span class="links-sep" aria-hidden="true">|</span>

  <!-- Logout form styled as a link -->
  <form method="POST" action="{% url 'logout' %}" class="logout-form">
    {% csrf_token %}
    <button type="submit" class="logout-button">Logout</button>
  </form>

  <span class="links-sep" aria-hidden="true">|</span>

  <a href="https://github.com/scarpent/chesser" target="_blank" rel="noopener"
    >Source Code / Docs</a
  >

  <span class="server-started" title="{{ BUILD_STARTED_AT|date:'c' }}">
    Server started: {{ BUILD_STARTED_AT|date:"Y-m-d H:i:s T" }}
    ({{BUILD_STARTED_AT|timesince }} ago)
  </span>
</div>

<!-- Safe JSON embed using Django json_script (avoids escapejs pitfalls) -->
{{ home_data|json_script:"home-data" }}
<script>
  window.homeData = JSON.parse(document.getElementById("home-data").textContent);
  console.log("homeData:", window.homeData);
</script>

<script type="module">
  import { homeApp, nextDueTimer } from "{% static 'js/home.js' %}";

  window.homeApp = homeApp;
  window.nextDueTimer = nextDueTimer;

  document.addEventListener("alpine:init", () => {
    Alpine.data("homeApp", homeApp);
    Alpine.data("nextDueTimer", nextDueTimer);
  });
</script>
{% endblock %}
